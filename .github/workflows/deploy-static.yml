name: Deploy Static Build to GitHub Pages

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy-static:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Verify Pre-built Files
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üîç Checking Pre-built Godot Export Files"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""

          REQUIRED_FILES=(
            "GodotAIv2.html"
            "GodotAI.js"
            "GodotAI.wasm"
            "GodotAI.pck"
            "GodotAI.png"
            "GodotAI.icon.png"
            "GodotAI.apple-touch-icon.png"
            "GodotAI.audio.worklet.js"
          )

          ALL_PRESENT=true

          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              SIZE=$(du -h "$file" | cut -f1)
              echo "‚úÖ $file ($SIZE)"
            else
              echo "‚ùå $file - MISSING!"
              ALL_PRESENT=false
            fi
          done

          echo ""

          if [ "$ALL_PRESENT" = false ]; then
            echo "‚ö†Ô∏è  ERROR: Some pre-built files are missing!"
            echo "Please export from Godot locally first:"
            echo "   1. Open project in Godot Editor"
            echo "   2. Project > Export > Web"
            echo "   3. Export to project root"
            echo "   4. Commit the exported files"
            exit 1
          fi

          echo "‚úÖ All pre-built files present!"
          echo ""
          echo "üìä Total Size:"
          du -sh . | grep -E '^\S+' || echo "Calculating..."
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: üìÅ Prepare Deployment Directory
        run: |
          mkdir -p deploy

          # Copy all Godot export files
          cp GodotAI.* deploy/ 2>/dev/null || true

          echo "Copied files to deploy directory:"
          ls -lh deploy/

      - name: üîó Create index.html Redirect
        run: |
          cat > deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>3DAIRE - Asistente Industrial con IA</title>
            <meta name="description" content="Plataforma 3D interactiva para gesti√≥n industrial con inteligencia artificial">
            <script>
              // Redirecci√≥n instant√°nea
              window.location.replace('GodotAIv2.html');
            </script>
            <meta http-equiv="refresh" content="0; url=GodotAIv2.html">
            <style>
              body { 
                margin: 0; 
                padding: 0; 
                background: #242424; 
                color: white; 
                font-family: 'Segoe UI', Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                flex-direction: column;
              }
              .loader {
                width: 50px;
                height: 50px;
                border: 5px solid #333;
                border-top: 5px solid #4a9eff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
              }
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
              a {
                color: #4a9eff;
                text-decoration: none;
                font-weight: bold;
              }
              a:hover {
                text-decoration: underline;
              }
            </style>
          </head>
          <body>
            <div class="loader"></div>
            <p>Cargando 3DAIRE... <a href="GodotAIv2.html">Haz clic aqu√≠ si no se redirige</a></p>
          </body>
          </html>
          EOF

          echo "‚úÖ index.html redirect created"

      - name: üîí Create CORS Headers for WebAssembly
        run: |
          cat > deploy/_headers << 'EOF'
          # CORS headers required for SharedArrayBuffer and WebAssembly threads
          /*
            Cross-Origin-Embedder-Policy: require-corp
            Cross-Origin-Opener-Policy: same-origin
            Access-Control-Allow-Origin: *
            Cache-Control: public, max-age=3600

          # Cache static assets longer
          /*.wasm
            Cache-Control: public, max-age=31536000, immutable

          /*.js
            Cache-Control: public, max-age=31536000, immutable

          /*.pck
            Cache-Control: public, max-age=31536000, immutable
          EOF

          echo "‚úÖ _headers file created with CORS and caching rules"

      - name: üìä Deployment Summary
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üì¶ Files Ready for Deployment"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          ls -lh deploy/
          echo ""
          echo "Total deployment size:"
          du -sh deploy/
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: üåê Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: üì§ Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./deploy"

      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ‚úÖ Deployment Complete
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë                                                       ‚ïë"
          echo "‚ïë   üéâ  3DAIRE Deployment Successful!                   ‚ïë"
          echo "‚ïë                                                       ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "üåê Live Site:"
          echo "   üìç Main: https://aiciorg.github.io/AICI/"
          echo "   üìç Direct: https://aiciorg.github.io/AICI/GodotAIv2.html"
          echo ""
          echo "üì¶ Deployed Files:"
          echo "   ‚úÖ GodotAIv2.html    - Entry point"
          echo "   ‚úÖ GodotAI.js      - Engine (~324KB)"
          echo "   ‚úÖ GodotAI.wasm    - Runtime (~34MB)"
          echo "   ‚úÖ GodotAI.pck     - Game data (~50MB)"
          echo "   ‚úÖ Assets          - Icons, audio worklets"
          echo ""
          echo "üéÆ Features Active:"
          echo "   ‚úÖ 3D Warehouse Environment"
          echo "   ‚úÖ First-Person Camera (WASD + Mouse)"
          echo "   ‚úÖ AI Chat System (Press T)"
          echo "   ‚úÖ Industrial Asset Library"
          echo ""
          echo "üì± How to Test:"
          echo "   1Ô∏è‚É£  Open URL (wait ~5s for 84MB download)"
          echo "   2Ô∏è‚É£  Click canvas to capture mouse"
          echo "   3Ô∏è‚É£  Use WASD to move, Mouse to look around"
          echo "   4Ô∏è‚É£  Press ESC to release mouse"
          echo "   5Ô∏è‚É£  Press T to open AI chat"
          echo ""
          echo "‚ö° Deployment Speed: < 30 seconds"
          echo "   (No compilation - just static file deployment!)"
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  Ready to use! Clear browser cache if needed.        ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
